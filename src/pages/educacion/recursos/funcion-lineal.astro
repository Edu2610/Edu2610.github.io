---
import Layout from '../../../layouts/Layout.astro';
---

<Layout titulo="Lab: Función Lineal">
  <div class="background-grid"></div>

  <main class="tool-container">
    <header>
      <a href="/educacion/recursos" class="btn-back">← Volver</a>
      <h1>Laboratorio <span class="cyan">Función Lineal</span></h1>
      <p>Ajusta los deslizadores para explorar el comportamiento de la pendiente y la intersección.</p>
    </header>

    <div class="jxgbox-wrapper">
      <div id="jxgbox" class="jxgbox"></div>

      <div id="hud" class="hud-container" aria-live="polite">
        <span class="hud-label">MODELO ACTUAL</span>
        <div class="hud-math" id="hudMath">f(x) = 1x + 0</div>
      </div>

      <button id="btnClear" class="btn-clear" type="button">
        <span class="btn-clear__icon">×</span>
        <span class="btn-clear__text">Limpiar puntos</span>
      </button>
    </div>

  </main>
</Layout>

<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraph.css" />

<style>
  /* --- FONDO Y LAYOUT --- */
  .background-grid {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -10;
    background-color: #0f172a;
    background-image: linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
  }

  .tool-container { max-width: 1000px; margin: 0 auto; padding: 2rem; }
  h1 { color: #fff; font-size: 2.5rem; margin-bottom: 0.5rem; }
  p { color: #94a3b8; margin-bottom: 2rem; }
  .cyan { color: #22d3ee; font-family: monospace; }
  .btn-back { color: #94a3b8; text-decoration: none; display: block; margin-bottom: 1rem; }

  /* --- CONTENEDOR GRÁFICO --- */
  .jxgbox-wrapper {
    position: relative;
    width: 100%;
    margin-bottom: 2rem;
  }

  .jxgbox {
    width: 100%; height: 600px;
    border: 1px solid rgba(34, 211, 238, 0.3);
    border-radius: 12px;
    background-color: #0f172a;
    box-shadow: 0 0 30px rgba(34, 211, 238, 0.05);
    overflow: hidden;
  }

  :global(.jxgbox svg) { background-color: transparent !important; }

  /* --- HUD --- */
  .hud-container {
    position: absolute;
    top: 15px; right: 15px; z-index: 50;
    background: rgba(15, 23, 42, 0.85);
    backdrop-filter: blur(8px);
    border: 1px solid rgba(34, 211, 238, 0.5);
    border-radius: 10px;
    padding: 12px 18px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    pointer-events: none;
  }

  .hud-label {
    display: block; color: #94a3b8; font-size: 0.7rem; font-weight: bold; letter-spacing: 1px; margin-bottom: 4px;
  }

  .hud-math {
    color: #fff; font-family: 'Courier New', monospace; font-size: 1.4rem; font-weight: bold;
  }
  
  :global(.val-m) { color: #22d3ee; }
  :global(.val-n) { color: #c084fc; }

  /* --- BOTÓN LIMPIAR --- */
  .btn-clear {
    position: absolute; bottom: 15px; right: 15px; z-index: 60;
    display: flex; align-items: center; gap: 8px;
    padding: 8px 16px;
    background: rgba(248, 113, 113, 0.1);
    border: 1px solid rgba(248, 113, 113, 0.3);
    border-radius: 8px;
    color: #fca5a5;
    cursor: pointer;
    transition: all 0.2s ease;
    backdrop-filter: blur(4px);
  }

  .btn-clear:hover {
    background: rgba(248, 113, 113, 0.2);
    border-color: #f87171;
    transform: translateY(-2px);
  }

  .btn-clear__icon { font-size: 1.2rem; font-weight: bold; }
  .btn-clear__text { font-size: 0.9rem; font-family: monospace; }

</style>

<script is:inline src="https://cdn.jsdelivr.net/npm/jsxgraph/distrib/jsxgraphcore.js"></script>

<script is:inline>
  // --- CONFIGURACIÓN ---
  
  // Factor de corrección para pantallas de alta densidad (Retina)
  // Si tus puntos salen a la mitad de distancia, esto lo arregla.
  const FACTOR_CALIBRACION = 2.0; 

  const board = JXG.JSXGraph.initBoard('jxgbox', {
    boundingbox: [-2, 8, 8, -2],
    axis: true,
    showCopyright: false,
    showNavigation: false,
    pan: { enabled: true },
    zoom: { enabled: true },
    maxFrameRate: 60,
    keepaspectratio: false,
    grid: { strokeColor: 'rgba(255, 255, 255, 0.05)' }
  });

  const axisStyle = { strokeColor: '#94a3b8', ticks: { strokeColor: '#94a3b8', label: { strokeColor: '#94a3b8' } } };
  board.defaultAxes.x.setAttribute(axisStyle);
  board.defaultAxes.y.setAttribute(axisStyle);

  // --- OBJETOS ---

  const sliderM = board.create('slider', [[-1, 7], [3, 7], [-5, 1, 5]], {
    name: 'm', strokeColor: '#22d3ee', fillColor: '#0f172a',
    baseline: { strokeColor: '#475569', strokeWidth: 3 },
    highline: { strokeColor: '#22d3ee', strokeWidth: 4 },
    label: { color: '#22d3ee', fontSize: 16 }
  });

  const sliderN = board.create('slider', [[-1, 6], [3, 6], [-5, 0, 5]], {
    name: 'n', strokeColor: '#c084fc', fillColor: '#0f172a',
    baseline: { strokeColor: '#475569', strokeWidth: 3 },
    highline: { strokeColor: '#c084fc', strokeWidth: 4 },
    label: { color: '#c084fc', fontSize: 16 }
  });

  const f = board.create('functiongraph', [
    function(x) { return sliderM.Value() * x + sliderN.Value(); }
  ], { strokeColor: '#22d3ee', strokeWidth: 4 });


  // --- HUD ---
  const hudElement = document.getElementById('hudMath');

  function updateHUD() {
    const m = sliderM.Value();
    const n = sliderN.Value();
    const mStr = Math.abs(m) < 0.01 ? "0" : (Number.isInteger(m) ? m.toFixed(0) : m.toFixed(2));
    const nStr = Math.abs(n) < 0.01 ? "0" : (Number.isInteger(n) ? Math.abs(n).toFixed(0) : Math.abs(n).toFixed(2));
    const signo = n >= 0 ? "+" : "-";

    if (hudElement) {
      hudElement.innerHTML = `f(x) = <span class="val-m">${mStr}</span>x ${signo} <span class="val-n">${nStr}</span>`;
    }
  }

  sliderM.on('drag', updateHUD);
  sliderN.on('drag', updateHUD);
  sliderM.on('change', updateHUD);
  sliderN.on('change', updateHUD);
  updateHUD();


  // --- INTERACCIÓN Y CALIBRACIÓN ---

  let gliders = [];

  board.on('down', function(e) {
    const items = board.getAllObjectsUnderMouse(e);
    if (items.some(obj => obj.elType === 'point' || obj.elType === 'glider')) return;

    // 1. Obtener coordenadas crudas
    const coordsRaw = board.getUsrCoordsOfMouse(e);
    
    // 2. APLICAR FACTOR DE CALIBRACIÓN (DUPLICAR)
    // Aquí es donde corregimos el error de escala
    const x = coordsRaw[0] * FACTOR_CALIBRACION;
    const y = coordsRaw[1] * FACTOR_CALIBRACION;

    // 3. Lógica de "Imán" usando las coordenadas corregidas
    const yRecta = sliderM.Value() * x + sliderN.Value();
    
    const bbox = board.getBoundingBox();
    const alturaVis = bbox[1] - bbox[3];
    const tolerancia = alturaVis * 0.05;

    if (Math.abs(y - yRecta) <= tolerancia) {
      const g = board.create('glider', [x, 0, f], {
        name: function() { 
          const X = this.X();
          const Y = this.Y();
          const xS = Math.abs(X) > 10 ? X.toFixed(0) : X.toFixed(1);
          const yS = Math.abs(Y) > 10 ? Y.toFixed(0) : Y.toFixed(1);
          return `(${xS}, ${yS})`; 
        },
        size: 5, color: '#fff', strokeColor: '#22d3ee',
        label: { color: '#cbd5e1', fontSize: 12, offset: [10, 10] }
      });
      gliders.push(g);
    }
  });

  document.getElementById('btnClear')?.addEventListener('click', function() {
    board.removeObject(gliders);
    gliders = [];
  });

</script>